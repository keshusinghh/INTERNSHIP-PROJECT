<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Nexus Board</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('dashboard') }}">Nexus Board</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="{{ url_for('dashboard') }}">Dashboard</a>
                    </li>
                </ul>
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item me-3">
                        <a class="nav-link btn btn-outline-light" href="{{ url_for('task_management') }}">
                            <i class="bi bi-list-task"></i> Task Management
                        </a>
                    </li>
                    <li class="nav-item me-3">
                        <a class="nav-link btn btn-outline-light" href="{{ url_for('team_chat') }}">
                            <i class="bi bi-chat-dots"></i> Team Chat
                        </a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-person-circle"></i> {{ session.username }}
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#userInfoModal">Your Account</a></li>
                            <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#changePasswordModal">Change Password</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="{{ url_for('logout') }}">Logout</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid py-4">
        {% with messages = get_flashed_messages() %}
            {% if messages %}
                {% for message in messages %}
                    <div class="alert alert-success alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card shadow">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0">Overview</h4>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                <h5>Task Distribution</h5>
                                <canvas id="taskChart" width="250" height="250" style="max-width:250px; max-height:250px"></canvas>
                            </div>
                            <div class="col-md-4">
                                <h5>Quick Stats</h5>
                                <div class="list-group">
                                    <div class="list-group-item d-flex justify-content-between align-items-center">
                                        To Do Tasks
                                        <span class="badge bg-primary rounded-pill">{{ to_do_tasks|length }}</span>
                                    </div>
                                    <div class="list-group-item d-flex justify-content-between align-items-center">
                                        In Progress Tasks
                                        <span class="badge bg-warning rounded-pill">{{ in_progress_tasks|length }}</span>
                                    </div>
                                    <div class="list-group-item d-flex justify-content-between align-items-center">
                                        Completed Tasks
                                        <span class="badge bg-success rounded-pill">{{ done_tasks|length }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Team Progress Section removed to avoid duplication -->
        
        <!-- Team Progress Section (Standalone) -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card shadow">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0">Team Progress</h4>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Team Member</th>
                                        <th>Task</th>
                                        <th>Status</th>
                                        <th>Last Updated</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for task in team_tasks %}
                                    <tr>
                                        <td>
                                            {% for member in team_members %}
                                                {% if member.id == task.user_id %}
                                                    {{ member.username }}
                                                {% endif %}
                                            {% endfor %}
                                        </td>
                                        <td>{{ task.title }}</td>
                                        <td>
                                            {% if task.status == 'to_do' %}
                                                <span class="badge bg-primary">To Do</span>
                                            {% elif task.status == 'in_progress' %}
                                                <span class="badge bg-warning">In Progress</span>
                                            {% elif task.status == 'done' %}
                                                <span class="badge bg-success">Done</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ task.updated_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                    </tr>
                                    {% else %}
                                    <tr>
                                        <td colspan="4" class="text-center">No team tasks available</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Task Management Section is now controlled from the navbar -->

        <!-- Collapsible Task Management Section -->
        <div class="collapse" id="taskManagementSection">
            <div class="row mb-4">
                <div class="col-md-12">
                    <div class="card shadow">
                        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                            <h4 class="mb-0">Task Management</h4>
                            <div></div>
                        </div>
                        <div class="card-body">
                            <!-- Task Filtering Controls -->
                            <div class="row mb-3">
                                <div class="col-md-12">
                                    <div class="card">
                                        <div class="card-body">
                                            <h5 class="card-title">Filter Tasks</h5>
                                            <div class="row g-3">
                                            <div class="col-md-4">
                                                <label for="priorityFilter" class="form-label">Priority</label>
                                                <select class="form-select" id="priorityFilter">
                                                    <option value="all" selected>All Priorities</option>
                                                    <option value="high">High</option>
                                                    <option value="medium">Medium</option>
                                                    <option value="low">Low</option>
                                                </select>
                                            </div>
                                            <div class="col-md-4">
                                                <label for="statusFilter" class="form-label">Status</label>
                                                <select class="form-select" id="statusFilter">
                                                    <option value="all" selected>All Statuses</option>
                                                    <option value="to_do">To Do</option>
                                                    <option value="in_progress">In Progress</option>
                                                    <option value="done">Done</option>
                                                </select>
                                            </div>
                                            <div class="col-md-4">
                                                <label for="searchFilter" class="form-label">Search</label>
                                                <input type="text" class="form-control" id="searchFilter" placeholder="Search by title...">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="card mb-4">
                                    <div class="card-header bg-light">
                                        <h5 class="mb-0">To Do</h5>
                                    </div>
                                    <div class="card-body">
                                        {% if to_do_tasks %}
                                            {% for task in to_do_tasks %}
                                                <div class="card mb-2 task-card">
                                                    <div class="card-body">
                                                        <h6 class="card-title">{{ task.title }} 
                                                            {% if task.priority == 'high' %}
                                                                <span class="badge bg-danger">High</span>
                                                            {% elif task.priority == 'medium' %}
                                                                <span class="badge bg-warning">Medium</span>
                                                            {% elif task.priority == 'low' %}
                                                                <span class="badge bg-info">Low</span>
                                                            {% endif %}
                                                        </h6>
                                                        <p class="card-text small">{{ task.description }}</p>
                                                        <div class="d-flex justify-content-end">
                                                            <a href="{{ url_for('edit_task', task_id=task.id) }}" class="btn btn-sm btn-outline-primary me-2">
                                                                <i class="bi bi-pencil"></i>
                                                            </a>
                                                            <a href="{{ url_for('delete_task', task_id=task.id) }}" class="btn btn-sm btn-outline-danger" onclick="return confirm('Are you sure you want to delete this task?')">
                                                                <i class="bi bi-trash"></i>
                                                            </a>
                                                        </div>
                                                    </div>
                                                </div>
                                            {% endfor %}
                                        {% else %}
                                            <p class="text-muted text-center">No tasks to do</p>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card mb-4">
                                    <div class="card-header bg-light">
                                        <h5 class="mb-0">In Progress</h5>
                                    </div>
                                    <div class="card-body">
                                        {% if in_progress_tasks %}
                                            {% for task in in_progress_tasks %}
                                                <div class="card mb-2 task-card">
                                                    <div class="card-body">
                                                        <h6 class="card-title">{{ task.title }} 
                                                            {% if task.priority == 'high' %}
                                                                <span class="badge bg-danger">High</span>
                                                            {% elif task.priority == 'medium' %}
                                                                <span class="badge bg-warning">Medium</span>
                                                            {% elif task.priority == 'low' %}
                                                                <span class="badge bg-info">Low</span>
                                                            {% endif %}
                                                        </h6>
                                                        <p class="card-text small">{{ task.description }}</p>
                                                        <div class="d-flex justify-content-end">
                                                            <a href="{{ url_for('edit_task', task_id=task.id) }}" class="btn btn-sm btn-outline-primary me-2">
                                                                <i class="bi bi-pencil"></i>
                                                            </a>
                                                            <a href="{{ url_for('delete_task', task_id=task.id) }}" class="btn btn-sm btn-outline-danger" onclick="return confirm('Are you sure you want to delete this task?')">
                                                                <i class="bi bi-trash"></i>
                                                            </a>
                                                        </div>
                                                    </div>
                                                </div>
                                            {% endfor %}
                                        {% else %}
                                            <p class="text-muted text-center">No tasks in progress</p>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card mb-4">
                                    <div class="card-header bg-light">
                                        <h5 class="mb-0">Done</h5>
                                    </div>
                                    <div class="card-body">
                                        {% if done_tasks %}
                                            {% for task in done_tasks %}
                                                <div class="card mb-2 task-card">
                                                    <div class="card-body">
                                                        <h6 class="card-title">{{ task.title }} 
                                                            {% if task.priority == 'high' %}
                                                                <span class="badge bg-danger">High</span>
                                                            {% elif task.priority == 'medium' %}
                                                                <span class="badge bg-warning">Medium</span>
                                                            {% elif task.priority == 'low' %}
                                                                <span class="badge bg-info">Low</span>
                                                            {% endif %}
                                                        </h6>
                                                        <p class="card-text small">{{ task.description }}</p>
                                                        <div class="d-flex justify-content-end">
                                                            <a href="{{ url_for('edit_task', task_id=task.id) }}" class="btn btn-sm btn-outline-primary me-2">
                                                                <i class="bi bi-pencil"></i>
                                                            </a>
                                                            <a href="{{ url_for('delete_task', task_id=task.id) }}" class="btn btn-sm btn-outline-danger" onclick="return confirm('Are you sure you want to delete this task?')">
                                                                <i class="bi bi-trash"></i>
                                                            </a>
                                                        </div>
                                                    </div>
                                                </div>
                                            {% endfor %}
                                        {% else %}
                                            <p class="text-muted text-center">No completed tasks</p>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Team Progress Section moved to Overview -->
    </div>

    <!-- Add Task Modal -->
    <div class="modal fade" id="addTaskModal" tabindex="-1" aria-labelledby="addTaskModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="addTaskModalLabel">Add New Task</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form action="{{ url_for('add_task') }}" method="POST">
                        <div class="mb-3">
                            <label for="title" class="form-label">Task Title</label>
                            <input type="text" class="form-control" id="title" name="title" required>
                        </div>
                        <div class="mb-3">
                            <label for="description" class="form-label">Description</label>
                            <textarea class="form-control" id="description" name="description" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="status" class="form-label">Status</label>
                            <select class="form-select" id="status" name="status" required>
                                <option value="to_do">To Do</option>
                                <option value="in_progress">In Progress</option>
                                <option value="done">Done</option>
                            </select>
                        </div>
                        
                        <div class="text-end">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-primary">Add Task</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <footer class="py-4 bg-dark mt-5">
        <div class="container">
            <p class="m-0 text-center text-white">Copyright &copy; Nexus Board 2023. All rights reserved.</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- User Info Modal -->
    <div class="modal fade" id="userInfoModal" tabindex="-1" aria-labelledby="userInfoModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="userInfoModalLabel">Your Account</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Name:</label>
                        <p>{{ session.username }}</p>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Role:</label>
                        <p>Employee</p>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Email:</label>
                        <p>{{ session.email }}</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div class="modal fade" id="changePasswordModal" tabindex="-1" aria-labelledby="changePasswordModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="changePasswordModalLabel">Change Password</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form action="{{ url_for('change_password') }}" method="POST">
                        <div class="mb-3">
                            <label for="current_password" class="form-label">Current Password</label>
                            <input type="password" class="form-control" id="current_password" name="current_password" required>
                        </div>
                        <div class="mb-3">
                            <label for="new_password" class="form-label">New Password</label>
                            <input type="password" class="form-control" id="new_password" name="new_password" required>
                        </div>
                        <div class="mb-3">
                            <label for="confirm_password" class="form-label">Confirm New Password</label>
                            <input type="password" class="form-control" id="confirm_password" name="confirm_password" required>
                        </div>
                        <div class="text-end">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-primary">Update Password</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Task Distribution Chart
            const taskCtx = document.getElementById('taskChart');
            if (taskCtx) {
                const taskChart = new Chart(taskCtx.getContext('2d'), {
                    type: 'pie',
                    data: {
                        labels: ['To Do', 'In Progress', 'Done'],
                        datasets: [{
                            label: 'Tasks',
                            data: [
                                {% if to_do_tasks %}{{ to_do_tasks|length }}{% else %}0{% endif %}, 
                                {% if in_progress_tasks %}{{ in_progress_tasks|length }}{% else %}0{% endif %}, 
                                {% if done_tasks %}{{ done_tasks|length }}{% else %}0{% endif %}
                            ],
                            backgroundColor: [
                                'rgba(13, 110, 253, 0.7)',
                                'rgba(255, 193, 7, 0.7)',
                                'rgba(25, 135, 84, 0.7)'
                            ],
                            borderColor: [
                                'rgba(13, 110, 253, 1)',
                                'rgba(255, 193, 7, 1)',
                                'rgba(25, 135, 84, 1)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'right',
                            }
                        }
                    }
                });
            }

            // Task Filtering Functionality
            document.addEventListener('DOMContentLoaded', function() {
                const priorityFilter = document.getElementById('priorityFilter');
                const statusFilter = document.getElementById('statusFilter');
                const searchFilter = document.getElementById('searchFilter');
                
                // Function to filter tasks
                function filterTasks() {
                    const priorityValue = priorityFilter.value;
                    const statusValue = statusFilter.value;
                    const searchValue = searchFilter.value.toLowerCase();
                    
                    // Get all task cards
                    const taskCards = document.querySelectorAll('.task-card');
                    
                    taskCards.forEach(card => {
                        // Get task properties
                        const title = card.querySelector('.card-title').textContent.toLowerCase();
                        const priority = card.querySelector('.badge') ? 
                            card.querySelector('.badge').textContent.toLowerCase() : '';
                        
                        // Determine status from parent container
                        let status = '';
                        if (card.closest('.card').querySelector('.card-header h5').textContent.includes('To Do')) {
                            status = 'to_do';
                        } else if (card.closest('.card').querySelector('.card-header h5').textContent.includes('In Progress')) {
                            status = 'in_progress';
                        } else if (card.closest('.card').querySelector('.card-header h5').textContent.includes('Done')) {
                            status = 'done';
                        }
                        
                        // Apply filters
                        const matchesPriority = priorityValue === 'all' || priority.toLowerCase() === priorityValue;
                        const matchesStatus = statusValue === 'all' || status === statusValue;
                        const matchesSearch = searchValue === '' || title.includes(searchValue);
                        
                        // Show or hide based on filter matches
                        if (matchesPriority && matchesStatus && matchesSearch) {
                            card.style.display = '';
                        } else {
                            card.style.display = 'none';
                        }
                    });
                }
                
                // Add event listeners to filters
                if (priorityFilter) priorityFilter.addEventListener('change', filterTasks);
                if (statusFilter) statusFilter.addEventListener('change', filterTasks);
                if (searchFilter) searchFilter.addEventListener('input', filterTasks);
            });

            // Progress Chart (Weekly)
            const progressCtx = document.getElementById('progressChart');
            if (progressCtx) {
                const progressChart = new Chart(progressCtx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
                        datasets: [{
                            label: 'Tasks Completed',
                            data: [5, 8, 12, {% if done_tasks %}{{ done_tasks|length }}{% else %}0{% endif %}],
                            backgroundColor: 'rgba(25, 135, 84, 0.2)',
                            borderColor: 'rgba(25, 135, 84, 1)',
                            borderWidth: 2,
                            tension: 0.3
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Number of Tasks'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Time Period'
                                }
                            }
                        }
                    }
                });
            }
        });
    </script>
</body>
</html>